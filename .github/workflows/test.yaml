on:
  pull_request:
  workflow_dispatch:

env:
  # Pytest marker expression used to discover integration tests
  # Modify this to change which tests are included in the CI matrix
  INTEGRATION_PYTEST_MARKER_EXPR: "vm_required and not inspect_eval"
  # Use libvirt provider in CI (Vagrantfiles support both qemu and libvirt)
  VAGRANT_DEFAULT_PROVIDER: libvirt

jobs:
  unit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v3
      - run: uv run pytest -m unit

  discover-integration:
    runs-on: ubuntu-latest
    outputs:
      tests: ${{ steps.collect.outputs.tests }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup uv
        uses: astral-sh/setup-uv@v3

      - name: Collect integration tests
        id: collect
        run: |
          # Collect tests matching the marker expression defined in env.INTEGRATION_PYTEST_MARKER_EXPR
          output=$(uv run pytest --collect-only -q -m "$INTEGRATION_PYTEST_MARKER_EXPR" 2>&1) || true
          echo "$output"
          tests=$(echo "$output" \
            | grep "::" \
            | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "tests=$tests" >> "$GITHUB_OUTPUT"
          echo "Discovered tests (marker: $INTEGRATION_PYTEST_MARKER_EXPR):"
          echo "$tests" | jq .

  integration:
    needs: discover-integration
    # Skip if no tests were discovered
    if: ${{ needs.discover-integration.outputs.tests != '[]' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        test: ${{ fromJson(needs.discover-integration.outputs.tests) }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup uv
        uses: astral-sh/setup-uv@v3

      - name: Check KVM availability
        run: |
          echo "Checking /dev/kvm..."
          if [ ! -e /dev/kvm ]; then
            echo "ERROR: /dev/kvm not found. KVM is required for VM tests."
            exit 1
          fi
          ls -la /dev/kvm
          echo "Checking CPU virtualization support..."
          grep -E -c '(vmx|svm)' /proc/cpuinfo

      - name: Enable KVM group permissions
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Install libvirt and QEMU
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            bridge-utils \
            dnsmasq-base \
            ebtables \
            libarchive-tools \
            libvirt-clients \
            libvirt-daemon \
            libvirt-daemon-system \
            libvirt-dev \
            qemu-kvm \
            qemu-utils

      - name: Start libvirtd
        run: |
          sudo systemctl enable --now libvirtd
          sudo systemctl status libvirtd

      - name: Add user to libvirt and kvm groups
        run: |
          sudo usermod -a -G libvirt,kvm "$USER"
          # Verify group membership (won't show until re-login, but that's ok)
          groups || true

      - name: Install Vagrant
        run: |
          wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt-get update
          sudo apt-get install -y vagrant
          vagrant --version

      - name: Install vagrant-libvirt plugin
        run: |
          vagrant plugin install vagrant-libvirt
          vagrant plugin list

      - name: Cache Vagrant boxes
        uses: actions/cache@v4
        with:
          path: ~/.vagrant.d/boxes
          # Invalidates when any Vagrantfile changes (e.g., box version update)
          key: vagrant-boxes-libvirt-${{ hashFiles('test/Vagrantfile*') }}
          restore-keys: vagrant-boxes-libvirt-

      - name: Run VM integration test
        run: |
          # Run with sg to get libvirt group permissions
          sg libvirt -c "uv run pytest '${{ matrix.test }}' -v -s --tb=short"

      - name: Cleanup VMs
        if: always()
        run: |
          # List any running VMs
          sudo virsh list --all || true
          # Destroy any VMs that might be left over
          for vm in $(sudo virsh list --name 2>/dev/null); do
            sudo virsh destroy "$vm" || true
            sudo virsh undefine "$vm" || true
          done
