name: Integration Test (VM)

on:
  pull_request:
  workflow_dispatch: # Allow manual triggering

jobs:
  vm-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Setup uv
        uses: astral-sh/setup-uv@v3

      - name: Check KVM availability
        run: |
          echo "Checking /dev/kvm..."
          ls -la /dev/kvm || echo "/dev/kvm not found"
          echo "Checking CPU virtualization support..."
          grep -E -c '(vmx|svm)' /proc/cpuinfo || true

      - name: Enable KVM group permissions
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Install libvirt and QEMU
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            bridge-utils \
            dnsmasq-base \
            ebtables \
            libarchive-tools \
            libvirt-clients \
            libvirt-daemon \
            libvirt-daemon-system \
            libvirt-dev \
            qemu-kvm \
            qemu-utils

      - name: Start libvirtd
        run: |
          sudo systemctl enable --now libvirtd
          sudo systemctl status libvirtd

      - name: Add user to libvirt and kvm groups
        run: |
          sudo usermod -a -G libvirt,kvm "$USER"
          # Verify group membership (won't show until re-login, but that's ok)
          groups || true

      - name: Install Vagrant
        run: |
          wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt-get update
          sudo apt-get install -y vagrant
          vagrant --version

      - name: Install vagrant-libvirt plugin
        run: |
          vagrant plugin install vagrant-libvirt
          vagrant plugin list

      - name: Cache Vagrant boxes
        uses: actions/cache@v4
        with:
          path: ~/.vagrant.d/boxes
          key: vagrant-boxes-libvirt-${{ hashFiles('test/Vagrantfile.ci') }}
          restore-keys: |
            vagrant-boxes-libvirt-

      - name: Run single VM integration test
        run: |
          # Run with newgrp to get libvirt group permissions
          sg libvirt -c "uv run pytest test/test_ci_vm.py::test_ci_vm_basic -v -s --tb=short"

      - name: Cleanup VMs on failure
        if: failure()
        run: |
          # List any running VMs
          sudo virsh list --all || true
          # Destroy any VMs that might be left over
          for vm in $(sudo virsh list --name 2>/dev/null); do
            sudo virsh destroy "$vm" || true
            sudo virsh undefine "$vm" || true
          done
